name: Weather Data Streaming - Solo

# Trigger workflow setiap 5 menit
on:
    schedule:
        # Setiap Senin dan Kamis jam 00:00 UTC (2x seminggu)
        - cron: "0 0 * * 1,4"
    workflow_dispatch:

jobs:
    fetch-weather:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Set Git config
              run: |
                  git config --local user.email "action@github.com"
                  git config --local user.name "GitHub Action Bot"

            - name: Fetch weather data for Solo
              env:
                  API_KEY: ${{ secrets.VITE_API_KEY }}
              run: |
                  import json
                  import csv
                  from datetime import datetime
                  import urllib.request

                  # OpenWeatherMap API
                  city = "Solo"
                  country = "ID"
                  api_key = "${{ env.API_KEY }}"
                  url = f"https://api.openweathermap.org/data/2.5/weather?q={city},{country}&appid={api_key}&units=metric&lang=id"

                  # Fetch data
                  try:
                      with urllib.request.urlopen(url) as response:
                          data = json.loads(response.read().decode())
                          
                          # Transform data (ETL)
                          weather_record = {
                              'waktu': datetime.utcnow().isoformat() + 'Z',
                              'kota': data.get('name', 'Solo'),
                              'negara': data.get('sys', {}).get('country', 'ID'),
                              'suhu_celsius': data.get('main', {}).get('temp', 0),
                              'terasa_seperti_celsius': data.get('main', {}).get('feels_like', 0),
                              'kelembapan_persen': data.get('main', {}).get('humidity', 0),
                              'kecepatan_angin_mps': data.get('wind', {}).get('speed', 0),
                              'kecepatan_angin_kmh': round(data.get('wind', {}).get('speed', 0) * 3.6, 2),
                              'cuaca_utama': data.get('weather', [{}])[0].get('main', ''),
                              'deskripsi_cuaca': data.get('weather', [{}])[0].get('description', ''),
                              'ikon_cuaca': data.get('weather', [{}])[0].get('icon', '01d'),
                              'tutupan_awan_persen': data.get('clouds', {}).get('all', 0),
                              'tekanan_hpa': data.get('main', {}).get('pressure', 0),
                              'visibilitas_m': data.get('visibility', 0),
                          }
                          
                          # Save to CSV
                          csv_file = 'data/weather_data_solo.csv'
                          file_exists = __import__('os').path.exists(csv_file)
                          
                          with open(csv_file, 'a', newline='', encoding='utf-8') as f:
                              writer = csv.DictWriter(f, fieldnames=weather_record.keys())
                              if not file_exists:
                                  writer.writeheader()
                              writer.writerow(weather_record)
                          
                          print(f"✓ Data cuaca berhasil disimpan: {weather_record['waktu']}")
                          print(f"  Suhu: {weather_record['suhu_celsius']}°C")
                          print(f"  Kelembapan: {weather_record['kelembapan_persen']}%")
                          print(f"  Angin: {weather_record['kecepatan_angin_kmh']} km/h")
                          
                  except Exception as e:
                      print(f"✗ Error fetching weather data: {str(e)}")
                      exit(1)
              shell: python

            - name: Commit and push changes
              run: |
                  git add data/weather_data_solo.csv
                  git diff --quiet && git diff --staged --quiet || (
                    git commit -m "chore: Update weather data for Solo - $(date -u +'%Y-%m-%d %H:%M:%S') UTC"
                    git push origin main
                  )
